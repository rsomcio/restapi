# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

**Running the application:**
```bash
# Start the server (requires DATABASE_URL environment variable)
go run main.go

# Build the application
go build -o restapi main.go
```

**Testing:**
```bash
# Run all tests
make test
# OR
go test ./...

# Run only unit tests (no database required)
make test-unit
# OR  
go test ./models ./handlers -short

# Run integration tests (requires DATABASE_URL)
make test-integration
# OR
go test ./database

# Generate test coverage report
make test-coverage
```

**Dependencies:**
```bash
# Install dependencies
go mod tidy

# Add new dependencies
go get <package-name>
```

## Environment Variables

Required for operation:
- `DATABASE_URL`: PostgreSQL connection string (e.g., `postgres://user:password@localhost/dbname?sslmode=disable`)
- `PORT`: Server port (optional, defaults to 3000)

## Architecture Overview

This is a simple REST API for event management built with Go and Fiber framework.

**Core Architecture:**
- **Fiber HTTP Framework**: Used for REST API endpoints with middleware for CORS, logging, and recovery
- **SQLx + PostgreSQL**: Database layer using SQLx for queries and PostgreSQL-specific features like UUID generation
- **Three-layer structure**: Handlers → Models → Database

**Key Design Patterns:**
- **Database-first UUIDs**: Event IDs are auto-generated by PostgreSQL using `gen_random_uuid()`
- **Auto-managed timestamps**: `created_at` and `updated_at` handled by database defaults and triggers
- **RETURNING queries**: INSERT/UPDATE operations return the full record to get auto-generated fields
- **Enhanced logging**: All log messages include filename and line numbers using `runtime.Caller()`

**Data Flow:**
1. HTTP requests → Fiber handlers (`handlers/events.go`)
2. Request validation (required fields, formats, email validation)
3. Database operations via SQLx (`database/connection.go`)
4. JSON responses with proper HTTP status codes

**Database Schema Key Points:**
- Events table uses UUID primary keys with database-level generation
- Date stored as DATE type, time as TIME type (not timestamps)
- Contact fields are optional with length constraints
- Auto-updating `updated_at` timestamp on record changes

**Validation Rules:**
- Required fields: `name`, `venue_name`, `address`, `date`, `time`
- Date format: YYYY-MM-DD
- Time format: HH:MM:SS  
- Email validation via regex for `contact_email`
- Field length limits enforced at database level

**Error Handling:**
- Consistent error response format: `{"error": "message"}`
- Enhanced logging with file:line information for debugging
- Proper HTTP status codes (400 for validation, 404 for not found, 500 for server errors)

## Testing Strategy

**Test Structure:**
- **Unit tests**: Test validation functions, JSON serialization, and HTTP request handling without database
- **Integration tests**: Test actual database operations (require DATABASE_URL)
- **Validation tests**: Separate tests for email, date, and time format validation

**Test Categories:**
- `models/*_test.go`: JSON serialization and model validation
- `handlers/validation_test.go`: Input validation functions  
- `handlers/events_test.go`: HTTP endpoint validation (no database)
- `database/*_test.go`: Database connection and schema tests

**Running Tests:**
- Unit tests run without external dependencies using `-short` flag
- Integration tests are skipped when DATABASE_URL is not set
- Use the Makefile for convenient test running with proper flags

## Important Notes

- The database connection is established once at startup and reused globally via `database.DB`
- All database queries explicitly list column names (no SELECT *)
- The spec.md file is the authoritative source for API behavior and should be referenced for any changes
- Logging functions are duplicated across files - consider consolidating if making changes
- Tests are designed to run independently and skip integration tests when no database is available